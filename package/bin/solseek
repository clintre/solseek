#!/bin/bash
SS_VERSION="0.5.2"

#Create cache/config directory if it does'nt exist
mkdir -p "$HOME/.cache/solseek"
mkdir -p "$HOME/.config/solseek"

SS_DATA_PATH="/usr/share/solseek"
# Defaults
# SS_LANG=${LANG:0:2} temp disabling as testing languages
SS_LANG="en"
SS_FASTFETCH=1
SS_ASSUMEYES=0

# Check for local config
if [ -f "$HOME/.config/solseek/config" ]; then
  . "$HOME/.config/solseek/config"
fi

if [ "$SS_ASSUMEYES" -eq 1 ]; then
  SS_ASSUMEYES="-y"
else
  SS_ASSUMEYES=""
fi

SS_LANG_PATH="$SS_DATA_PATH/lang/$SS_LANG"

if [ ! -d "$SS_LANG_PATH" ]; then
  SS_LANG_PATH="$SS_DATA_PATH/lang/en"
fi
if [ ! -f "$SS_LANG_PATH/_dictionary.lang" ]; then
  . "$SS_DATA_PATH/lang/en/_dictionary.lang"
else
  . "$SS_LANG_PATH/_dictionary.lang"
fi
# Sub Action switch
ISSA=0

# Cache settings
# Cache expires time in minutes - will move to config file later to override this if set
SS_CACHE_EXPIRES=10
PA_CACHE_FILE="$HOME/.cache/solseek/apackages"
PI_CACHE_FILE="$HOME/.cache/solseek/ipackages"
FA_CACHE_FILE="$HOME/.cache/solseek/aflatpaks"
FI_CACHE_FILE="$HOME/.cache/solseek/iflatpaks"
UP_CACHE_FILE="$HOME/.cache/solseek/updatemsg"
UL_CACHE_FILE="$HOME/.cache/solseek/updatelst"

#Supported Update Systems
HAS_FLATPAK=0
HAS_SNAP=0
HAS_DISTROBOX=0
HAS_FIRMWARE=0
HAS_FASTFETCH=0

if command -v "flatpak" &> /dev/null; then
  HAS_FLATPAK=1
fi
if command -v "snap" &> /dev/null; then
  HAS_SNAP=1
fi
if command -v "distrobox" &> /dev/null; then
  HAS_DISTROBOX=1
fi
if command -v "fwupdmgr" &> /dev/null; then
  HAS_FIRMWARE=1
fi
if command -v "fastfetch" &> /dev/null; then
  HAS_FASTFETCH=1
  SS_FASTFETCH_CFG="solseek_fastfetch.jsonc"
  ## Check for config override
  if [ "$SS_FASTFETCH" -eq 2 ]; then
    SS_FASTFETCH_CFG="solseek_fastfetch_str.jsonc"
  elif [ "$SS_FASTFETCH" -eq 0 ]; then
    HAS_FASTFETCH=0
  fi
fi

check_updates(){
  
  rm -f "$UL_CACHE_FILE"
  rm -f "$UP_CACHE_FILE"

  HASUP=0
  UPCNT_SOLUS=0
  UPCNT_FP=0
  UPMSG_FP=""
  NOTI_LVL="normal"
  NOTI_ID=""

  # If called from the systemctl service, set to critical
  if [ "$1" == "system" ]; then
    NOTI_LVL="critical"
    NOTI_ID="--replace-id=11111"
  fi

  # Make sure we are getting the latest
  pkcon refresh force &> /dev/null

  UPCNT_SOLUS_STBL=`pkcon get-updates --plain | grep -i -c "(Solus)"`
  UPCNT_SOLUS_USTBL=`pkcon get-updates --plain | grep -i -c "(Unstable)"`


  if [ "$HAS_FLATPAK" -eq 1 ]; then
    UPCNT_FP=`flatpak remote-ls --updates | wc -l`
  fi

  if [ "$UPCNT_SOLUS_STBL" -gt 0 ]; then
    HASUP=1
    UPCNT_SOLUS=$UPCNT_SOLUS_STBL
  elif [ "$UPCNT_SOLUS_USTBL" -gt 0 ]; then
    HASUP=1
    UPCNT_SOLUS=$UPCNT_SOLUS_USTBL
  fi

  if [ "$UPCNT_FP" -gt 0 ]; then
    HASUP=1
    UPMSG_FP="| $MSG_UPD_FLATPAK: $UPCNT_FP"
  fi

  if [ "$HASUP" -eq 1 ]; then
    UPMSG="$MSG_UPD_SYSTEM: $UPCNT_SOLUS $UPMSG_FP"
    if [ "$1" == "system" ]; then
      notify-send --app-name="Solseek" --urgency="$NOTI_LVL" "$NOTI_ID" -t 9000 -i solseek "$MSG_UPD_AVAIL_UPD: $UPMSG"
    fi
    rm -f "$UL_CACHE_FILE"
    touch "$UL_CACHE_FILE"
    echo "Solus:" >> "$UL_CACHE_FILE"
    eopkg lu | awk -F' - ' '{print "\033[1;92m" $1 "\033[0m\n" $2"\n"}' >> "$UL_CACHE_FILE"
    echo "\n" >> "$UL_CACHE_FILE"
    if [ "$UPCNT_FP" -gt 0 ]; then
      echo "Flatpak:" >> "$UL_CACHE_FILE"
      flatpak remote-ls --updates --columns=name,version  >> "$UL_CACHE_FILE"
      echo "\n" >> "$UL_CACHE_FILE"
      hr >> "$UL_CACHE_FILE"
    fi
  else
    UPMSG="$MSG_UPD_NONE"
  fi
    echo "$UPMSG" > "$UP_CACHE_FILE"
}

clean_cache(){
    rm -f "$PI_CACHE_FILE"
    rm -f "$PA_CACHE_FILE"
    rm -f "$FI_CACHE_FILE"
    rm -f "$FA_CACHE_FILE"
    if [ "$1" == "regen" ]; then
      echo "$MSG_GEN_CACHE"
      if [ "$HAS_FLATPAK" -eq 1 ]; then

        flatpak list --app --columns=application,name |  sed -E 's/\x09(.*)/|\o33[32m⬤ \1\o33[0m/' |  sort -t '|' -k 2 > "$FI_CACHE_FILE" &

        flatpak remote-ls --system flathub --columns=application,name | \
        awk '!seen[$1]++' | \
        grep -v 'org\.freedesktop\.Platform\.GL32\.nvidia\|org\.freedesktop\.Platform\.GL\.nvidia' | \
        sed -E 's/\t(.*)/|◯ \1/' | \
        sort -t '|' -k 2 > "$FA_CACHE_FILE"

        # If the user has no flatpaks installed, lets create an empty entry for FZF
        if [ ! -s "$FI_CACHE_FILE" ]; then
          touch "$FI_CACHE_FILE"
          echo "Empty|Empty" > "$FI_CACHE_FILE"
          #If it does lets merge the installed entries with available as FP has no command for this
          else
          FP_TEMP_FILE=$(mktemp)

          awk -F'|' '

          FNR==NR {
              # Store the entire line using the first field (Package ID) as the key
              installed[$1] = $0
              next
          }

          $1 in installed {
              # Print the stored replacement line and skip to the next record
              print installed[$1]
              next
          }

          { print }
          ' "$FI_CACHE_FILE" "$FA_CACHE_FILE" > "$FP_TEMP_FILE" && mv "$FP_TEMP_FILE" "$FA_CACHE_FILE"

          rm -f "$FP_TEMP_FILE"
        fi

      fi
      check_updates &
      eopkg li 2>/dev/null | awk 'NR>2 {print $1 "|" "\033[32m" "⬤ " $1 "\033[0m"}' > "$PI_CACHE_FILE" &
      eopkg la -U -N 2>/dev/null | awk 'NR>2 {print $1 "|" "◯ " $1 }' > "$PA_CACHE_FILE"
    fi
}
hr(){
  line="─"
  if [ "$1" = "2" ]; then
    line="═"
  elif [ "$1" = "3" ]; then
    line="━"
  fi
  printf "%.0s$line" $(seq 1 "$(tput cols)"); echo
}
# Help and calls
case "$1" in
  "-h" | "--help" )
  printf "$(<$SS_LANG_PATH/help.txt )"
  exit 0
  ;;
  "--version")
  echo "solseek $SS_VERSION"
  exit 0
  ;;
esac
# System service update check
if [ "$1" == "-cu" ]; then
  check_updates "system"
  exit 0
fi
# Internal calls
if [ "$1" == "-ssh" ]; then
  case "$2" in
    "AMM_UPSYS" | "AMM_WELC")

      if [ ! -f "$UP_CACHE_FILE" ] || [ -n "$(find "$UP_CACHE_FILE" -mmin +"$SS_CACHE_EXPIRES" 2>/dev/null)" ]; then
        check_updates
      fi

      UPMSG="$(<$UP_CACHE_FILE)"
  esac
  case "$2" in
    "AMM_LST_PA" | "AMM_LST_PI" | "AMM_LST_PU" | "AMM_LST_FA" | "AMM_LST_FI")
      printf "$(<$SS_LANG_PATH/list.txt )" | fold -s -w 80 2>/dev/null ;;
    "AMM_UPSYS")
      printf "$MSG_UPD_AVAIL_UPD: $UPMSG\n"
      hr
      if [ -f "$UL_CACHE_FILE" ]; then
        printf "$(<$UL_CACHE_FILE)"
        hr
      fi
      printf "$(<$SS_LANG_PATH/update_system.txt )" ;;
    "AMP_RINST"  | "AMP_REM" | "AMP_SCHK" | "AMP_UPDT")
      printf "$MSG_PKG_ISTATMSG\n"
      printf "$(<$SS_LANG_PATH/package_action.txt )" | fold -s -w 60 2>/dev/null ;;
    "AMP_INST")
      printf "$MSG_PKG_ASTATMSG\n"
      printf "$(<$SS_LANG_PATH/package_action.txt )" | fold -s -w 60 2>/dev/null ;;
    "AMM_TOOLS")
      printf "$(<$SS_LANG_PATH/information.txt )" | fold -s -w 60 2>/dev/null ;;
    "AMM_WELC")
      printf "$MSG_UPD_AVAIL_UPD: $UPMSG\n"
      hr
      if [ "$HAS_FASTFETCH" -eq 1 ]; then
        fastfetch -c /usr/share/solseek/"$SS_FASTFETCH_CFG" 2>/dev/null
        hr
      fi
      printf "$(<$SS_LANG_PATH/welcome.txt )" | fold -s -w 60 2>/dev/null ;;
    "A_BACK")
      echo "$MSG_GEN_BACK" ;;
    "SELPKG")
      printf "$MSG_PKG_SELECTED\n"
      hr
      echo "$3"| tr -s ' ' '\n'
      hr
      printf "$(<$SS_LANG_PATH/package_action.txt )" | fold -s -w 60 2>/dev/null
      ;;
    "AMM_QUIT")
      echo "$MSG_GEN_EXIT" ;;
    *) echo "$MSG_APP_NAME" ;;
  esac
  exit 0
elif [ "$1" == "-ssi" ]; then
  if [ -n "$2" ]; then
    if [ -n "$3" ]; then
      selpkg_clean=$(echo "${@:3}" | grep -o '[^ ]*|' | tr -d '|')
      echo -e "$MSG_PKG_SELECTED: $selpkg_clean" | fold -s -w 80 2>/dev/null
      hr
      echo -e "\033[1m> $2 \033[0m\n"
    fi
    eopkg info $2 | awk 'NR==1{next} / :/{if(NR>2)print ""; sub(/\s+:\s*/, ":\n"); print; next} {sub(/^\s+/, ""); print} END{print ""}' | fold -s -w 60 2>/dev/null

  else
    echo "$MSG_GEN_SEL_ITEM"
  fi
  exit 0
elif [ "$1" == "-ssfi" ]; then
  if [ -n "$2" ]; then
    appstreamcli get --details $2 | awk '/^[^ ]/ { skip = ($0 ~ /^(Identifier|Internal ID|Icon|Bundle|Default Screenshot URL):/) } !skip' | fold -s -w 60 2>/dev/null

  else
    echo "$MSG_GEN_SEL_ITEM"
  fi
  exit 0
elif [ "$1" == "-sse" ]; then
  sse_export=0
  sse_export_fn=""
  sse_sudo=0
  sse_type="eopkg"

  case "$2" in
  "AMT_FPLA" | "AMT_FPLU")
      sse_type="flatpak" ;;
  "AMT_INXI")
      sse_type="inxi" ;;
  "AMT_WSOLUSSPRT" | "AMT_WSOLUSFRM" | "AMT_WSOLSEEKWIKI" | "AMT_WLIC")
      echo "$MSG_INFO_OPENWEB"
      exit 0 ;;
  "A_BLANK")
      echo " "
      exit 0 ;;
  esac

  if [ "$sse_type" = "eopkg" ]; then

    if [ "$2" = "AMT_EHIST" ]; then
      sse_cmd="hs"
      sse_export_fn="$HOME/eopkg_history.txt"
      sse_sudo=1
    elif [ "$2" = "AMT_EINST" ]; then
      sse_cmd="li"
      sse_export_fn="$HOME/eopkg_all_installed.txt"
    elif [ "$2" = "AMT_EUSER" ]; then
      sse_cmd="li -e"
      sse_export_fn="$HOME/eopkg_user_installed.txt"
    elif [ "$2" = "AMT_LREPO" ]; then
      sse_cmd="lr"
      sse_export_fn="$HOME/eopkg_repos.txt"
    elif [ "$2" = "AMT_ECHECK" ]; then
      if [ "$3" == "run" ]; then
        hr 3
        echo -e "$ACT_INFO_CHECK: eopkg check";
        hr
        sudo eopkg check
        hr
        read -p "$MSG_GEN_PRESSENTER..."
      else
        echo $MSG_INFO_RUNPVTOP
        hr
        echo -e "$ACT_INFO_CHECK: eopkg check";
      fi
      exit 0
    elif [ "$2" = "AMT_ERMO" ]; then
      if [ "$3" == "run" ]; then
        hr 3
        echo -e "$ACT_INFO_ERMO: eopkg remove-orphans";
        hr
        sudo eopkg rmo
        hr
        read -p "$MSG_GEN_PRESSENTER..."
      else
        echo $MSG_INFO_RUNPVTOP
        hr
        echo -e "$ACT_INFO_ERMO: eopkg remove-orphans";
      fi
      exit 0
    elif [ "$2" = "AMT_FPCLEAN" ]; then
      if [ "$3" == "run" ]; then
        hr 3
        echo -e "$ACT_INFO_FPCLEAN: flatpak uninstall --unused";
        hr
        flatpak uninstall --unused
        hr
        read -p "$MSG_GEN_PRESSENTER..."
      else
        echo $MSG_INFO_RUNPVTOP
        hr
        echo -e "$ACT_INFO_FPCLEAN: flatpak uninstall --unused";
      fi
      exit 0
    else
      echo "$MSG_GEN_BACK"
      exit 0
    fi

    if [ "$3" == "export" ]; then
      if (( sse_sudo == 1 )); then
        sudo eopkg "$sse_cmd" > $sse_export_fn
      else
        eopkg $sse_cmd > $sse_export_fn
      fi
      hr 3
      echo "$MSG_GEN_EXPTO: $sse_export_fn"
      hr
      read -p "$MSG_GEN_PRESSENTER..."
    else
      echo "$MSG_INFO_EXPPVTOP"
      hr
      eopkg $sse_cmd
    fi
  elif [ "$sse_type" = "flatpak" ]; then
    if [ "$2" = "AMT_FPLA" ]; then
      sse_cmd="list"
      sse_export_fn="$HOME/flatpak_all_installed.txt"
      sse_sudo=1
    elif [ "$2" = "AMT_FPLU" ]; then
      sse_cmd="list --app"
      sse_export_fn="$HOME/flatpak_user_installed.txt"
    fi
    if [ "$3" == "export" ]; then
      flatpak $sse_cmd > $sse_export_fn
      hr 3
      echo "$MSG_GEN_EXPTO: $sse_export_fn"
      hr
      read -p "$MSG_GEN_PRESSENTER..."
    else
      echo "$MSG_INFO_EXPPVTOP"
      hr
      printf "$(flatpak $sse_cmd --columns=name,version 2>/dev/null)"
    fi
  elif [ "$sse_type" = "inxi" ]; then
    sse_export_fn="$HOME/inxi_output.txt"
    if [ "$3" == "export" ]; then
      inxi -b > $sse_export_fn
      hr 3
      echo "$MSG_GEN_EXPTO: $sse_export_fn"
      hr
      read -p "$MSG_GEN_PRESSENTER..."
    else
      echo "$MSG_INFO_EXPPVTOP"
      hr
      inxi -b --tty -y 80 2>/dev/null
    fi

  fi
  exit 0
elif [ "$1" == "-ssp" ]; then
  if [ $# -lt 3 ]; then
    echo "$MSG_GEN_INVPARAM"
    read -p "$MSG_GEN_PRESSENTER..."
  else
      ccache=0
      pkgvars="${3//$'\n'/ }"
      if [ "$2" == "install" ]; then
        pkg_mgmt_act="it"
        pkg_mgmt_title="$ACT_PKG_INSTALL: $pkgvars"
        ccache=1
      elif [ "$2" == "reinstall" ]; then
        pkg_mgmt_act="it --reinstall"
        pkg_mgmt_title="$ACT_PKG_REINSTALL: $pkgvars"
      elif [ "$2" == "update" ]; then
        pkg_mgmt_act="up"
        pkg_mgmt_title="$ACT_PKG_UPDATE: $pkgvars"
      elif [ "$2" == "remove" ]; then
        pkg_mgmt_act="rm"
        pkg_mgmt_title="$ACT_PKG_REMOVE: $pkgvars"
        ccache=1
      elif [ "$2" == "check" ]; then
        pkg_mgmt_act="check"
        pkg_mgmt_title="$ACT_PKG_CHECK: $pkgvars"
      fi

      hr 3
      echo -e "\e[1;31m$MSG_PKG_TTLSTART $pkg_mgmt_title\e[0m"
      hr
      sudo eopkg $pkg_mgmt_act $pkgvars $SS_ASSUMEYES
      if [ "$ccache" -eq 1 ]; then
        clean_cache "regen"
      fi
      hr 3
      echo "$MSG_GEN_PROCCOMP"
      read -p "$MSG_GEN_PRESSENTER..."
  fi
  exit 0
elif [ "$1" == "-ssf" ]; then
  if [ $# -lt 3 ]; then
    echo "$MSG_GEN_INVPARAM"
    read -p "$MSG_GEN_PRESSENTER..."
  else
      ccache=0
      pkgvars="${3//$'\n'/ }"
      if [ "$2" == "install" ]; then
        pkg_mgmt_act="install --system"
        pkg_mgmt_title="$ACT_PKG_INSTALL: $pkgvars"
        ccache=1
      elif [ "$2" == "reinstall" ]; then
        pkg_mgmt_act="install --reinstall --system"
        pkg_mgmt_title="$ACT_PKG_REINSTALL: $pkgvars"
      elif [ "$2" == "update" ]; then
        pkg_mgmt_act="update"
        pkg_mgmt_title="$ACT_PKG_UPDATE: $pkgvars"
      elif [ "$2" == "remove" ]; then
        pkg_mgmt_act="remove"
        pkg_mgmt_title="$ACT_PKG_REMOVE: $pkgvars"
        ccache=1
      elif [ "$2" == "repair" ]; then
        pkg_mgmt_act="repair"
        pkg_mgmt_title="$ACT_PKG_CHECK: $pkgvars"
      fi

      hr 3
      echo -e "\e[1;31m$MSG_PKG_TTLSTART $pkg_mgmt_title\e[0m"
      hr
      flatpak $pkg_mgmt_act $pkgvars $SS_ASSUMEYES
      if [ "$ccache" -eq 1 ]; then
        clean_cache "regen"
      fi
      hr 3
      echo "$MSG_GEN_PROCCOMP"
      read -p "$MSG_GEN_PRESSENTER..."
  fi
  exit 0
elif [ "$1" == "-u" ]; then
  shift $((OPTIND-1))
  up_eo=0
  up_fp=0
  up_sn=0
  up_db=0
  up_fw=0
  ccache=0

  for arg in "$@"; do
    if [[ "$arg" == *"="* ]]; then
      key="${arg%%=*}"
      value="${arg#*=}"
      declare "$key=$value"
    fi
  done

  hr 3
  echo -e "\e[1;31m$MSG_UPD_TTLSTART\e[0m"
  if (( up_eo == 1 )); then
    ccache=1
    hr
    echo -e "\e[1;34m█ EOPKG\e[0m\n"
    sudo eopkg up $SS_ASSUMEYES
  fi
  if (( up_fp == 1 && HAS_FLATPAK == 1 )); then
    ccache=1
    hr
    echo -e "\e[1;34m█ FLATPAK\e[0m\n"
    flatpak update -y
  fi
  if (( up_sn == 1 && HAS_SNAP == 1 )); then
    hr
    echo -e "\e[1;34m█ SNAP\e[0m\n"
    sudo snap refresh
  fi
  if (( up_db == 1 && HAS_DISTROBOX == 1 )); then
    hr
    echo -e "\e[1;34m█ DISTROBOX\e[0m\n"
    distrobox upgrade -a
  fi
  if (( up_fw == 1 && HAS_FIRMWARE == 1 )); then
    hr
    echo -e "\e[1;34m█ FIRMWARE\e[0m\n"
    sudo fwupdmgr refresh --force
    sudo fwupdmgr get-updates -y > /dev/null
    sudo fwupdmgr update
  fi
  if [ "$ccache" -eq 1 ]; then
    clean_cache "regen"
  fi
  hr 3
  echo "$MSG_GEN_PROCCOMP"
  ##read -p "$MSG_GEN_PRESSENTER..."
  read -n 1 -p "$MSG_GEN_PRESSENTERREB: " PUCHOICE
  case "$PUCHOICE" in
    # This matches either 'R' or 'r' (case-insensitive)
    [Rr])
        echo -e "\n\n$MSG_GEB_REBOOTIN..."
        echo "3"
        sleep 1
        echo "2"
        sleep 1
        echo "1"
        sleep 1
        reboot
        ;;
    *)
        exit 0
        ;;
  esac
  exit 0
elif [ "$1" == "subact" ]; then
  # We just set the sub action avoid running the fz logic up here
  ISSA=1

# If a paramater is passed, no matches above, pass off to eopkg
elif [ -n "$1" ]; then
  # Capture upgrades so we can do both eopkg and flatpak
  if [ "$1" = "up" ] || [ "$1" = "upgrade" ]; then
    solseek -u up_eo=1 up_fp=1
    exit 0
  fi

  eopkg "$@"
  exit 0
fi

#echo -e "\033[1m> $2 \033[0m\n"
## Base Styling
CSS_BOLDBRIGHT="\033[1m"
CSS_GREEN="\033[32m"
CSS_RED="\033[31m"
CSS_RESET="\033[0m"

# Include and setup Menus
. "/usr/share/solseek/menus"

## Remove features from menu for systems not installed
if [ "$HAS_FLATPAK" -eq 0 ]; then
  MENU_MAIN=$(echo "$MENU_MAIN" | grep -v '^AMM_SEC_FP|')
  MENU_MAIN=$(echo "$MENU_MAIN" | grep -v '^AMM_LST_FA|')
  MENU_MAIN=$(echo "$MENU_MAIN" | grep -v '^AMM_LST_FI|')
  MENU_UPDATE=$(echo "$MENU_UPDATE" | grep -v '^AMU_FLATPAK|')
  MENU_TOOLS=$(echo "$MENU_TOOLS" | grep -v '^AMT_FPLA|')
  MENU_TOOLS=$(echo "$MENU_TOOLS" | grep -v '^AMT_FPLU|')
  MENU_TOOLS=$(echo "$MENU_TOOLS" | grep -v '^AMT_FPCLEAN|')

fi
if [ "$HAS_SNAP" -eq 0 ]; then
  MENU_UPDATE=$(echo "$MENU_UPDATE" | grep -v '^AMU_SNAP|')
fi
if [ "$HAS_DISTROBOX" -eq 0 ]; then
  MENU_UPDATE=$(echo "$MENU_UPDATE" | grep -v '^AMU_DBOX|')
fi
if [ "$HAS_FIRMWARE" -eq 0 ]; then
  MENU_UPDATE=$(echo "$MENU_UPDATE" | grep -v '^AMU_FMW|')
fi

# General fzf wrapper with defaults
sa_fzf() {
  fzf --ansi\
      --delimiter='|' \
      --with-nth=2 \
      --nth=1 \
      --no-input\
      --disabled\
      --style="full"\
      --border\
      --border-label="$MSG_APP_NAME - v$SS_VERSION"\
      --footer-border \
      --footer="$MENU_FOOTER" \
      --highlight-line\
      --height=100% \
      --min-height=30 \
      --wrap \
      --preview-label="$MSG_GEN_INFO"\
      --preview-window=right:wrap:70%\
      --reverse \
      "$@"  # specific args for action
}
# Package list fzf wrapper with defaults
pkg_fzf() {
  fzf --ansi\
      --delimiter='|' \
      --with-nth=2 \
      --nth=1 \
      --style="full"\
      --border\
      --border-label="$MSG_APP_NAME - v$SS_VERSION"\
        --footer-label="$MSG_FTR_MS" \
        --footer-label-pos=0 \
      --footer-border \
      --footer="$MENU_FOOTER" \
      --highlight-line\
      --height=100% \
      --min-height=30 \
      --multi \
      --wrap \
      --preview-label="$MSG_GEN_INFO"\
      --preview-window=right:wrap:70%\
      --reverse \
      "$@"  # specific args for action
}


# Sub action area
# This allows step-up navigation versus always returning to the main menu
if [ "$ISSA" -eq 1 ]; then
  while true; do
  clear
  # Updates Sub Action
  if [ "$2" == "upsys" ]; then

    upmode=$(printf "%b" "$MENU_UPDATE" | sa_fzf --prompt="" --header="$ACT_MAIN_UPDATESYS" --preview 'solseek -ssh AMM_UPSYS')

    upmode=${upmode%|*}
    case "$upmode" in
      "A_BACK" | "") exit 0 ;;
      "AMU_EOPKG") solseek -u up_eo=1;;
      "AMU_FLATPAK") solseek -u up_fp=1;;
      "AMU_SNAP") solseek -u up_sn=1;;
      "AMU_ALL") solseek -u up_eo=1 up_fp=1 up_sn=1;;
      "AMU_DBOX") solseek -u up_db=1;;
      "AMU_FMW") solseek -u up_fw=1;;
      "AMU_ETHING") solseek -u up_eo=1 up_fp=1 up_sn=1 up_db=1 up_fw=1;;
      *) continue ;;
    esac
  # Tools Sub Action
  elif [ "$2" == "tools" ]; then
    toolAction=$(printf "%b" "$MENU_TOOLS" | sa_fzf --prompt="" --header="$ACT_MAIN_INFORMATION" --preview 'solseek -sse {1}')

    toolAction=${toolAction%|*}
    case "$toolAction" in
      "A_BACK" | "") exit 0 ;;
      "AMT_EHIST") solseek -sse "$toolAction" export ;;
      "AMT_EINST") solseek -sse "$toolAction" export ;;
      "AMT_EUSER") solseek -sse "$toolAction" export ;;
      "AMT_LREPO") solseek -sse "$toolAction" export ;;
      "AMT_FPLA") solseek -sse "$toolAction" export ;;
      "AMT_FPLU") solseek -sse "$toolAction" export ;;
      "AMT_INXI") solseek -sse "$toolAction" export ;;
      "AMT_ECHECK") solseek -sse "$toolAction" run ;;
      "AMT_ERMO") solseek -sse "$toolAction" run ;;
      "AMT_FPCLEAN") solseek -sse "$toolAction" run ;;
      "AMT_WSOLUSSPRT") xdg-open "https://github.com/getsolus/packages";;
      "AMT_WSOLUSFRM") xdg-open "https://discuss.getsol.us/" ;;
      "AMT_WSOLSEEKWIKI") xdg-open "https://github.com/clintre/solseek/wiki";;
      "AMT_WLIC") xdg-open "https://github.com/clintre/solseek?tab=GPL-3.0-1-ov-file" ;;
      *) continue ;;
    esac
  # Flatpaks Sub Action
  elif [ "$2" = "lif" ] || [ "$2" = "laf" ]; then
      #Flatpak List
      if [ ! -f "$FI_CACHE_FILE" ] || [ -n "$(find "$FI_CACHE_FILE" -mmin +"$SS_CACHE_EXPIRES" 2>/dev/null)" ]; then
          clean_cache "regen"
      fi
      #Clean dupes in FP list due to versions
      #sort -u -o "$FA_CACHE_FILE" "$FA_CACHE_FILE"

      if [ "$2" = "lif" ]; then
        app_list=$(< "$FI_CACHE_FILE")
        pkg_list_type="$ACT_MAIN_LISTIPKGS"
      else
        app_list=$(< "$FA_CACHE_FILE")
        pkg_list_type="$ACT_MAIN_LISTAPKGS"
      fi

      pkg=$(printf "%b" "$app_list" | pkg_fzf --prompt="$MSG_PKG_PROMPT: " --header="$ACT_UPD_FLATPAK - $pkg_list_type" --preview 'solseek -ssfi {1}')

      #pkg=${pkg%|*}
      # Return to main menu
      [ -z "$pkg" ] && exit 0
      if [[ "$pkg" == Empty* ]]; then
        continue
      fi
      package=$(echo "$pkg" | grep -o '[^ ]*|' | tr -d '|')

      if grep -q "$package" "$FI_CACHE_FILE"; then
        pkg_status="$MSG_GEN_INSTALLED"

        MENU_PKG=$(echo "$MENU_MPKG" | grep -v '^AMP_SCHK|')
      else
        pkg_status="$MSG_GEN_AVAILABLE"
        MENU_PKG="$MENU_IPKG"
      fi
      package="${package//$'\n'/ }"
      # PACKAGE ACTION
      pkgAction=$(printf "%b" "$MENU_PKG" | sa_fzf --prompt="" --header="$MSG_PKG_FPSEL" --preview "solseek -ssh SELPKG '$package'")

      pkgAction=${pkgAction%|*}
      case "$pkgAction" in
        "AMP_INST") solseek -ssf install "$package" ;;
        "AMP_RINST") solseek -ssf reinstall "$package" ;;
        "AMP_REM") solseek -ssf remove "$package" ;;
        "AMP_FPREP") solseek -ssf repair "$package" ;;
        "AMP_UPDT") solseek -ssf update "$package" ;;
        "A_BACK" | "") continue ;;
      esac
  # Packages Sub Action
  elif [ "$2" = "li" ] || [ "$2" = "la" ]; then

    # PACKAGE LIST
      if [ ! -f "$PI_CACHE_FILE" ] || [ -n "$(find "$PI_CACHE_FILE" -mmin +"$SS_CACHE_EXPIRES" 2>/dev/null)" ]; then
          clean_cache "regen"
      fi

      if [ "$2" = "li" ]; then
        app_list=$(< "$PI_CACHE_FILE")
        pkg_list_type="$ACT_MAIN_LISTIPKGS"
      else
        app_list=$(cat "$PI_CACHE_FILE" "$PA_CACHE_FILE" | sort)
        pkg_list_type="$ACT_MAIN_LISTAPKGS"
      fi
      pkg=$(printf "%b" "$app_list" | pkg_fzf --prompt="$MSG_PKG_PROMPT: " --header="$MSG_PKG_HEADER - $pkg_list_type" --preview 'solseek -ssi {1} {+}')
      #solseek -ssi {1} {+}

      # Return to main menu
      [ -z "$pkg" ] && exit 0

      package=$(echo "$pkg" | grep -o '[^ ]*|' | tr -d '|')

      if grep -q "$package" "$PI_CACHE_FILE"; then
        pkg_status="$MSG_GEN_INSTALLED"

        MENU_PKG=$(echo "$MENU_MPKG" | grep -v '^AMP_FPREP|')
      else
        pkg_status="$MSG_GEN_AVAILABLE"
        MENU_PKG="$MENU_IPKG"
      fi


      package="${package//$'\n'/ }"
      # PACKAGE ACTION
      pkgAction=$(printf "%b" "$MENU_PKG" | sa_fzf --prompt="" --header="$MSG_GEN_SEL" --preview "solseek -ssh SELPKG '$package'")

      pkgAction=${pkgAction%|*}
      case "$pkgAction" in
        "AMP_INST") solseek -ssp install "$package" ;;
        "AMP_RINST") solseek -ssp reinstall "$package" ;;
        "AMP_REM") solseek -ssp remove "$package" ;;
        "AMP_SCHK") solseek -ssp check "$package" ;;
        "AMP_UPDT") solseek -ssp update "$package" ;;
        "A_BACK" | "") continue ;;
      esac
  else
  exit 0
  fi
  done
  exit 0
fi

# End Sub action area

# Launch main menu with a clean cache
clean_cache "regen"
clear
# Start Interface
while true; do
  clear

  mode=$(printf "%b" "$MENU_MAIN" | sa_fzf --prompt="" --header="Solseek" --preview 'solseek -ssh {1}')

  mode=${mode%|*}

  case "$mode" in
    "AMM_QUIT" | "") exit 0 ;;
    "AMM_LST_PI") solseek subact li ;;
    "AMM_LST_PA") solseek subact la ;;
    "AMM_LST_FA") solseek subact laf ;;
    "AMM_LST_FI") solseek subact lif ;;
    "AMM_UPSYS") solseek subact upsys ;;
    "AMM_TOOLS") solseek subact tools ;;
    *) continue ;;
  esac
done
